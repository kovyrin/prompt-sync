# Prompt-Sync Lock File Format

## Overview

The `Promptsfile.lock` file tracks the exact state of installed prompt sources, including:

- Repository URLs and commit hashes
- All rendered files with their source mappings
- File content hashes for drift detection

## File Format

The lock file uses YAML format with the following structure:

```yaml
# Promptsfile.lock
# Generated by prompt-sync
# DO NOT EDIT MANUALLY

version: "1.0"
generated: 2025-06-24T10:30:00Z
sources:
  - url: https://github.com/acme/prompts.git
    ref: v1.0.0
    commit: abc123def456
    files:
      - path: .cursor/rules/_active/authentication.md
        source: prompts/security/auth.md
        hash: sha256:1234567890abcdef...
      - path: .cursor/rules/_active/validation.md
        source: prompts/security/validate.md
        hash: sha256:fedcba0987654321...
  - url: https://github.com/team/standards.git
    commit: xyz789abc123
    files:
      - path: .claude/commands/team-style.md
        source: commands/style-guide.md
        hash: sha256:abcdef1234567890...
```

## Field Descriptions

### Top Level Fields

- `version`: Lock file format version (currently "1.0")
- `generated`: ISO 8601 timestamp of when the lock file was generated
- `sources`: Array of locked source repositories

### Source Fields

- `url`: Full repository URL
- `ref`: Optional version reference (tag, branch) if specified in Promptsfile
- `commit`: Exact commit hash that was checked out
- `files`: Array of files rendered from this source

### File Fields

- `path`: Output path where the file was rendered (relative to workspace)
- `source`: Source path in the repository where this file came from
- `hash`: SHA256 hash of the rendered file content, prefixed with "sha256:"

## Source Path Tracking

The `source` field in each file entry enables:

1. **Better cleanup**: When updating versions, files that no longer exist in the new version are automatically removed
2. **Clear traceability**: Users can see exactly which source file generated each rendered output
3. **Rename detection**: If a source file is renamed, the old output can be cleaned up properly
4. **Debugging**: Makes it easier to understand where each rendered file originated

## Backwards Compatibility

Lock files without the `source` field are still supported. When reading old lock files:

- Missing `source` fields are treated as empty strings
- File cleanup still works based on output paths
- The lock file is upgraded to the new format on the next `install` command

## Usage

The lock file is used by various commands:

- `install`: Generates or updates the lock file
- `verify`: Checks if rendered files match the lock file hashes
- `remove`: Uses file listings to clean up rendered files
- `update`: Compares old vs new file lists to clean up orphaned files

## Example: Version Update Scenario

When updating from v1.0.0 to v2.0.0 of a source:

### Before (v1.0.0):

```yaml
files:
  - path: .cursor/rules/_active/auth.md
    source: prompts/authentication.md
    hash: sha256:oldHash...
```

### After (v2.0.0):

```yaml
files:
  - path: .cursor/rules/_active/auth-v2.md
    source: prompts/auth-patterns.md
    hash: sha256:newHash...
```

The installation process will:

1. Render the new file `auth-v2.md`
2. Detect that `auth.md` is no longer in the source
3. Automatically remove the orphaned `auth.md` file
